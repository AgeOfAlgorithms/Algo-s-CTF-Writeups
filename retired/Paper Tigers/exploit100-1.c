// Exploit 100-1 — Paper Tigers: Ret2libc Warmup (xinetd-friendly)
// - leaks libc address & stack pointer
// - reads up to 512 bytes and memcpy's into a 128-byte stack buffer (intentional overflow)

#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <dlfcn.h>
#include <stdint.h>
#include <signal.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

static void sig_handler(int sig) {
    (void)sig;
    _exit(2);
}

void init(void) {
    alarm(60);
    signal(SIGALRM, sig_handler);

    setvbuf(stdin, NULL, _IONBF, 0);
    setvbuf(stdout, NULL, _IONBF, 0);
    setvbuf(stderr, NULL, _IONBF, 0);

    const char *home = getenv("HOME");
    if (home && home[0]) {
        chdir(home);
    } else {
        chdir("/");
    }
}

/* libc & stack hints???? in MY poctf??? */
__attribute__((noinline))
void leak_addresses(char *bufptr) {
    void *libc_puts = dlsym(RTLD_DEFAULT, "puts");
    printf("%p\n", libc_puts);
    printf("%p\n", (void*)bufptr);
    fflush(stdout);
}

__attribute__((noinline))
void vuln(void) {
    char buf[128];

    char inputbuf[512];
    ssize_t n = read(STDIN_FILENO, inputbuf, sizeof(inputbuf));
    if (n <= 0) return;

    ssize_t preview_len = n < 120 ? n : 120;
    if (preview_len >= (ssize_t)sizeof(inputbuf)) preview_len = sizeof(inputbuf)-1;
    inputbuf[preview_len] = '\0';
    dprintf(STDOUT_FILENO, "You sent (preview): %.120s\n", inputbuf);
    fflush(stdout);

    if (n > 0) {
        memcpy(buf, inputbuf, (size_t)n); /* erm... the vulnerability is RIGHT behind me, isn't it? */
    }

    volatile uint8_t sink = 0;
    sink ^= buf[0];
    (void)sink;
}

int main(void) {
    init();

    setbuf(stdout, NULL);
    setbuf(stdin, NULL);
    setbuf(stderr, NULL);

    puts("=== Paper Tigers — Ret2libc Warmup ===");
    puts("legacy debug prints follow:");
    char scratch[16];
    leak_addresses(scratch);

    puts("Send your payload:");
    vuln();

    puts("Thanks for your input. Goodbye.");
    return 0;
}