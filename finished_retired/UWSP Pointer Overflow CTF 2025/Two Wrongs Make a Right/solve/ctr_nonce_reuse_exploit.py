#!/usr/bin/env python3
"""
CTR Nonce Reuse Exploit - Two Wrongs Make a Right

Author: Claude
Date: 2025-11-15
Challenge: Crypto 200-1 - UWSP Pointer Overflow CTF 2025

Purpose: Exploit CTR mode nonce reuse to recover P2 plaintext
Assumptions: P1 is exactly 592 bytes with email addresses (from challenge description)
Result: Successfully recovered P2 containing the flag

Flag: poctf{uwsp_7h15_fl46_15_4ll_5w34r_w0rd5}
"""

import binascii
import re

def xor_bytes(b1, b2):
    """XOR two byte arrays"""
    return bytes(x ^ y for x, y in zip(b1, b2))

def load_hex_file(filename):
    """Load hex string from file"""
    with open(filename, 'r') as f:
        return f.read().strip()

def main():
    # Load ciphertexts
    c1_hex = load_hex_file('../c1.hex')
    c2_hex = load_hex_file('../c2.hex')
    c1_bytes = binascii.unhexlify(c1_hex)
    c2_bytes = binascii.unhexlify(c2_hex)

    print("=== Final CTR Keystream Reuse Attack ===\n")

    # EXACT P1 from the challenge description
    p1 = """From: Tamsin <tamsin@pointeroverflowctf.com>
To: Mason <mason@pointeroverflowctf.com>
Date: Sat, 11 Oct 2025 10:02:05 -0500
Subject: System checks and handoff plan

Hey—quick handoff notes before I go off-grid:
 • Rotate the service tokens on barad-dur first, then traefik.
 • The staging login banner still shows "2024"; fix that.
 • If anyone pings you about CRYP 200-1, tell them it's *not* a padding-oracle.
 • Also: the validator only accepts lowercase flags.

Final reminder: never ship secrets in plaintext. Use proper key management and never reuse a CTR nonce again.

—T
"""

    p1_bytes = p1.encode('utf-8')

    print(f"P1 length: {len(p1_bytes)} bytes")
    print(f"C1 length: {len(c1_bytes)} bytes")
    print(f"Match: {'YES!' if len(p1_bytes) == len(c1_bytes) else 'NO'}\n")

    # Apply CTR attack: P2 = P1 ⊕ (C1 ⊕ C2)
    c1_xor_c2 = xor_bytes(c1_bytes, c2_bytes)
    p2_bytes = xor_bytes(p1_bytes, c1_xor_c2)

    # Decode P2
    p2_text = p2_bytes.decode('utf-8', errors='replace')

    print("=== RECOVERED P2 ===")
    print(p2_text)
    print("\n" + "="*60)

    # Search for flags
    flags = re.findall(r'poctf\{[^\}]+\}', p2_text, re.IGNORECASE)
    if flags:
        print(f"\n[+] FOUND FLAGS:")
        for flag in flags:
            print(f"    {flag}")
    else:
        print("\n[-] No poctf{{...}} pattern found")

    # Save P2 to file
    with open('p2_decoded.txt', 'w') as f:
        f.write(p2_text)
    print("\n[+] P2 saved to p2_decoded.txt")

if __name__ == "__main__":
    main()
